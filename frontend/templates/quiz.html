{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    {% if session.get('quiz_goal') == 'quiz' %}
    <div class="mb-4 animate__animated animate__fadeInDown">
        <div class="d-flex justify-content-between small fw-bold mb-1">
            <span style="color: #666;">You üèÉ</span>
            <span class="text-danger">AI Rival üëª</span>
        </div>
        <div class="progress rounded-pill shadow-sm" style="height: 14px; background: #eee; border: 2px solid #fff;">
            <div id="ghost-bar" class="progress-bar bg-danger" style="width: 0%; transition: linear; border-radius: 20px;"></div>
        </div>
    </div>
    {% endif %}

    <div class="glass-card shadow-lg p-4 p-md-5 animate__animated animate__fadeIn">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="badge {% if session.get('quiz_goal') == 'quiz' %}bg-danger{% else %}bg-warning text-dark{% endif %} px-4 py-2 rounded-pill fs-6 shadow-sm">
                {{ session.get('quiz_goal').upper() }} MODE
            </span>
            {% if session.get('quiz_goal') == 'quiz' %}
            <div class="h3 mb-0 text-danger fw-bold">‚è≥ <span id="timer">30</span>s</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-end mb-1">
                <h5 class="fw-bold mb-0">Question {{ current_num }} <span class="text-muted fs-6">of {{ total_num }}</span></h5>
                <span class="small fw-bold text-primary">{{ ((current_num / total_num) * 100)|int }}%</span>
            </div>
            <div class="progress" style="height: 8px; border-radius: 10px; background-color: #f0f0f0;">
                <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ (current_num / total_num) * 100 }}%;">
                </div>
            </div>
        </div>

        <hr class="mb-5 opacity-10">

        <h2 class="fw-bold mb-5" style="line-height: 1.4; color: #333;">{{ question.question_text }}</h2>

        <div id="feedback-area" class="alert d-none mb-4 rounded-4 shadow-sm animate__animated animate__bounceIn" style="border-left: 8px solid;">
            <h4 id="feedback-status" class="fw-bold"></h4>
            <p id="explanation-text" class="fs-5"></p>
            <button type="button" class="btn btn-dark btn-sm rounded-pill px-3 fw-bold" onclick="simplifyText()">
                <i class="fa-solid fa-baby me-1"></i> Simplify Explanation (ELI5)
            </button>
        </div>

        <form id="quiz-form" action="{{ url_for('routes.submit_answer', q_id=question.id) }}" method="POST">
            <div class="row g-3">
                {% for key, val in options.items() %}
                <div class="col-md-6">
                    <input type="radio" class="btn-check" name="answer" value="{{ key }}" id="opt-{{ key }}" required>
                    <label class="btn btn-outline-dark w-100 py-3 text-start rounded-4 fs-5 fw-bold shadow-sm option-card" for="opt-{{ key }}">
                        <span class="text-warning me-2">{{ key }}.</span> {{ val }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="mt-5 p-4 rounded-4 text-center" style="background: #FFF9E6; border: 2px dashed #D4A017;">
                <p class="small fw-bold text-muted mb-3">HOW CONFIDENT ARE YOU?</p>
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <input type="radio" class="btn-check" name="confidence" value="low" id="c1">
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c1">üò¨ Unsure</label>
                    
                    <input type="radio" class="btn-check" name="confidence" value="medium" id="c2" checked>
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c2">ü§î Guess</label>
                    
                    <input type="radio" class="btn-check" name="confidence" value="high" id="c3">
                    <label class="btn btn-outline-secondary rounded-pill px-4" for="c3">üòé Expert</label>
                </div>
            </div>

            <div class="mt-5">
                {% if session.get('quiz_goal') == 'revision' %}
                <button type="button" id="check-btn" class="sunshine-btn w-100 py-3 fs-4">Check Answer</button>
                <button type="submit" id="next-btn" class="sunshine-btn w-100 py-3 fs-4 d-none" style="background: #333; box-shadow: 0 5px 0 #000;">
                    Next Question <i class="fa-solid fa-arrow-right ms-2"></i>
                </button>
                {% else %}
                <button type="submit" class="sunshine-btn w-100 py-3 fs-4" style="background: linear-gradient(to right, #dc3545, #b02a37); box-shadow: 0 5px 0 #842029;">
                    Lock In Answer üîí
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
    /* Option Card Styling */
    .option-card {
        border: 2px solid #eee;
        background-color: #ffffff;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        color: #333;
    }
    .option-card:hover {
        border-color: #ccc;
        background-color: #f8f9fa;
    }
    /* Selection Highlight */
    .btn-check:checked + .option-card {
        border-color: #D4A017 !important;
        background-color: #FFD700 !important;
        color: #000 !important;
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(212, 160, 23, 0.4) !important;
    }
    .btn-check:checked + .option-card .text-warning {
        color: #8B4513 !important;
        font-weight: 900;
    }
    /* Sunshine Button style used across the app */
    .sunshine-btn {
        background: var(--primary-gold, #FFD700);
        border: none;
        border-radius: 15px;
        font-weight: bold;
        color: black;
        box-shadow: 0 5px 0 #D4A017;
        transition: all 0.1s;
    }
    .sunshine-btn:active {
        transform: translateY(3px);
        box-shadow: 0 2px 0 #D4A017;
    }
</style>

<script>
    const mode = "{{ session.get('quiz_goal') }}";
    const correct = "{{ question.correct_answer }}".toLowerCase();

    // 1. AI Rival and Timer Logic (Quiz Mode Only)
    if (mode === 'quiz') {
        let gWidth = 0;
        const gInt = setInterval(() => {
            gWidth += 0.5; // Rival finishes in approx 20 seconds
            const bar = document.getElementById('ghost-bar');
            if(bar) bar.style.width = gWidth + "%";
            if (gWidth >= 100) clearInterval(gInt);
        }, 100);

        let time = 30;
        const tInt = setInterval(() => {
            time--;
            const timerDisplay = document.getElementById('timer');
            if(timerDisplay) timerDisplay.innerText = time;
            if(time <= 0) {
                clearInterval(tInt);
                document.getElementById('quiz-form').submit();
            }
        }, 1000);
    }

    // 2. ELI5 Simplifier (AJAX call to /simplify)
    async function simplifyText() {
        const expl = document.getElementById('explanation-text');
        const originalText = expl.innerText;
        expl.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> AI is rethinking...';
        
        try {
            const res = await fetch('/simplify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({explanation: originalText})
            });
            const data = await res.json();
            expl.innerText = data.simplified;
        } catch (e) {
            expl.innerText = originalText;
        }
    }

    // 3. Revision Mode Feedback Toggle
    const checkBtn = document.getElementById('check-btn');
    if(checkBtn) {
        checkBtn.onclick = () => {
            const selected = document.querySelector('input[name="answer"]:checked');
            if(!selected) return alert("Please pick an answer first!");
            
            const area = document.getElementById('feedback-area');
            const status = document.getElementById('feedback-status');
            const expl = document.getElementById('explanation-text');

            area.classList.remove('d-none');
            expl.innerText = "{{ question.explanation }}";

            if(selected.value.toLowerCase() === correct) {
                area.className = "alert alert-success mb-4 rounded-4 shadow-sm animate__animated animate__bounceIn";
                area.style.borderLeft = "8px solid #28a745";
                status.innerText = "‚ú® Correct! You're on fire.";
            } else {
                area.className = "alert alert-danger mb-4 rounded-4 shadow-sm animate__animated animate__shakeX";
                area.style.borderLeft = "8px solid #dc3545";
                status.innerText = "‚ùå Incorrect. The correct answer is " + correct.toUpperCase();
            }
            checkBtn.classList.add('d-none');
            document.getElementById('next-btn').classList.remove('d-none');
        };
    }
</script>
{% endblock %}