{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="glass-card text-center h-100 shadow-sm p-4">
                <h5 class="fw-bold mb-3">Overall Accuracy</h5>
                <div style="height: 180px;"><canvas id="accuracyChart"></canvas></div>
                <h3 class="mt-3 text-warning">{{ streak }} Day Streak üî•</h3>
            </div>
        </div>
        <div class="col-md-8">
            <div class="glass-card h-100 shadow-sm p-4">
                <h2 class="display-6 font-weight-bold" style="color: #FFB300;">
                    Hello, {{ current_user.username or 'Explorer' }}! üöÄ
                </h2>
                <p class="lead text-muted">What are we learning today?</p>
                <div class="alert alert-warning border-0 shadow-sm mt-3" style="border-radius: 15px; background-color: #fffdf2;">
                    <strong>AI Tip:</strong> Use the <strong>Topic Name</strong> mode if you don't have notes handy‚ÄîI'll generate facts for you!
                </div>
            </div>
        </div>
    </div>

    <form action="{{ url_for('routes.handle_generation') }}" method="POST" enctype="multipart/form-data" id="quizForm" class="text-center">
        <h5 class="mb-4 text-secondary">Step 1: Choose Your Source üìö</h5>
        <div class="d-flex justify-content-center gap-4 mb-5 flex-wrap">
            <label class="source-card p-3 border">
                <input type="radio" name="source_type" value="pdf" onclick="updateInput('pdf')" required hidden>
                <div style="font-size: 3rem;">üìÑ</div>
                <b class="d-block mt-2">Upload PDF</b>
            </label>
            <label class="source-card p-3 border">
                <input type="radio" name="source_type" value="text" onclick="updateInput('text')" hidden>
                <div style="font-size: 3rem;">‚úçÔ∏è</div>
                <b class="d-block mt-2">Raw Text</b>
            </label>
            <label class="source-card p-3 border">
                <input type="radio" name="source_type" value="topic" onclick="updateInput('topic')" hidden>
                <div style="font-size: 3rem;">üí°</div>
                <b class="d-block mt-2">Topic Name</b>
            </label>
        </div>

        <div id="dynamicArea" class="mb-5 mx-auto" style="max-width: 600px; min-height: 100px;">
             <p class="text-muted border p-4 rounded bg-light border-dashed" style="border-style: dashed !important;">Select a source above to begin.</p>
        </div>

        <h5 class="mb-4 text-secondary">Step 2: Configuration ‚öôÔ∏è</h5>
        
        <div class="row justify-content-center p-4 bg-white rounded-4 shadow-sm mx-auto mb-5 border" style="max-width: 850px; border-radius: 20px;">
            <div class="col-md-4 mb-3 text-start">
                <label class="form-label fw-bold small text-muted">FORMAT</label>
                <select name="quiz_format" class="form-select border-0 bg-light">
                    <option value="mcq">Multiple Choice (MCQ)</option>
                    <option value="tf">True / False</option>
                    <option value="mixed">Mixed (MCQ & T/F)</option>
                    <option value="theory">Short Answers</option>
                </select>
            </div>
            <div class="col-md-4 mb-3 text-start">
                <label class="form-label fw-bold small text-muted">QUESTION COUNT</label>
                <input type="number" name="count" class="form-control border-0 bg-light" value="5" min="1" max="20">
            </div>
            <div class="col-md-4 mb-3 text-start">
                <label class="form-label fw-bold small text-muted">CHOOSE MODE</label>
                <select name="quiz_goal" class="form-select border-0 bg-light" id="modeSelect">
                    <option value="quiz">Timed Quiz ‚è±Ô∏è</option>
                    <option value="revision">Relaxed Revision üìñ</option>
                </select>
            </div>
        </div>
        <button type="submit" class="sunshine-btn w-50 py-3 mb-5 shadow-sm" id="genBtn">
            <span id="btnText">Generate Magic ‚ú®</span>
        </button>
    </form>
</div>

<style>
    .source-card { width: 150px; cursor: pointer; transition: 0.3s; border-radius: 20px; background: white; }
    .source-card:hover { transform: translateY(-5px); border-color: #FFB300 !important; background: #fffdf2; }
    label:has(input[type="radio"]:checked) { border-color: #FFB300 !important; background-color: #FFF9E6 !important; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function updateInput(val) {
    const area = document.getElementById('dynamicArea');
    if(val === 'pdf') {
        area.innerHTML = `<input type="file" name="pdf_file" class="form-control shadow-sm p-3" accept=".pdf" required style="border-radius:15px;">`;
    } else if(val === 'text') {
        area.innerHTML = `<textarea name="raw_text" class="form-control shadow-sm p-3" rows="4" placeholder="Paste your study notes here..." required style="border-radius:15px;"></textarea>`;
    } else {
        area.innerHTML = `<input type="text" name="topic_name" class="form-control shadow-sm p-3" placeholder="e.g. Photosynthesis or Quantum Physics" required style="border-radius:15px;">`;
    }
}

const ctx = document.getElementById('accuracyChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Correct', 'Incorrect'],
        datasets: [{
            data: [{{ correct_total or 0 }}, {{ incorrect_total or 0 }}],
            backgroundColor: ['#FFB300', '#F1F1F1'],
            borderWidth: 0
        }]
    },
    options: { cutout: '80%', plugins: { legend: { display: false } } }
});
</script>
{% endblock %}